name: release-tag

on:
  push:
    branches:
      - main

jobs:
  release-tag:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # required for tagging and creating releases

    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0

      # Include the token #major, #minor, #patch, or #none somewhere in the commit message of the merge commit or the relevant commit. Example: "feat: rewrite API endpoint to new microservice architecture #major"
      # If none of those tokens are found, it falls back to the default bump defined by DEFAULT_BUMP (which defaults to minor)
      - name: Bump version and push tag
        id: tag_version
        uses: anothrNick/github-tag-action@1.75.0  # Don't use @master or @v1 unless you're happy to test the latest version
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          DEFAULT_BUMP: patch # optional: can be none, major, minor, patch
          WITH_V: true        # optional: creates tags like v1.2.3

      - name: Get commit messages since last tag
        id: commits
        run: |
          last_tag=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          echo "Last tag: $last_tag"

          if [ -z "$last_tag" ]; then
            # No previous tags â†’ include all commits
            log=$(git log --pretty=format:"- %s")
          else
            log=$(git log $last_tag..HEAD --pretty=format:"- %s")
          fi

          # Make the log available as output
          log="${log//'%'/'%25'}"
          log="${log//$'\n'/'%0A'}"
          log="${log//$'\r'/'%0D'}"

          echo "commits=$log" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        if: steps.tag_version.outputs.new_tag != ''
        uses: softprops/action-gh-release@v2
        with:
          # If you want to automatically attach build artifacts (for example .zip, .tar.gz, or binaries) to the release, just add:
          # files: |
            # dist/*.zip
            # build/*.tar.gz
          tag_name: ${{ steps.tag_version.outputs.new_tag }}
          name: Release ${{ steps.tag_version.outputs.new_tag }}
          body: |
            ðŸš€ Automatic release for version ${{ steps.tag_version.outputs.new_tag }}

            ### Commits in this release:
            ${{ steps.commits.outputs.commits }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
